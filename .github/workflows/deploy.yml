name: íƒ€ì´ë¨¸ì•± ìžë™ë°°í¬

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      platform:
        description: 'ë°°í¬ í”Œëž«í¼'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - ios
        - android
      release_type:
        description: 'ë°°í¬ íƒ€ìž…'
        required: true
        default: 'beta'
        type: choice
        options:
        - beta
        - release
  
  # íƒœê·¸ í‘¸ì‹œ ì‹œ ìžë™ ì‹¤í–‰ (ì˜ˆ: v1.0.0)
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.24.5'

jobs:
  # iOS ë°°í¬
  deploy_ios:
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || startsWith(github.ref, 'refs/tags/')
    runs-on: macos-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Flutter ì„¤ì¹˜
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
    
    - name: Ruby ì„¤ì •
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: ios
    
    - name: Flutter ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
    
    - name: iOS ì½”ë“œ ì„œëª… ì„¤ì •
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
        p12-password: ${{ secrets.IOS_P12_PASSWORD }}
    
    - name: iOS í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì„¤ì¹˜
      uses: apple-actions/download-provisioning-profiles@v3
      with:
        bundle-id: com.dong.timerapp
        issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
        api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
    
    - name: iOS ë² íƒ€ ë°°í¬ (TestFlight)
      if: github.event.inputs.release_type == 'beta' || (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'beta'))
      working-directory: ios
      run: |
        fastlane beta
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
    
    - name: iOS í”„ë¡œë•ì…˜ ë°°í¬ (App Store)
      if: github.event.inputs.release_type == 'release' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'beta'))
      working-directory: ios
      run: |
        fastlane release
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}

  # Android ë°°í¬
  deploy_android:
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Java ì„¤ì •
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Flutter ì„¤ì¹˜
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
    
    - name: Ruby ì„¤ì •
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: android
    
    - name: Flutter ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
    
    - name: Android í‚¤ìŠ¤í† ì–´ ì„¤ì •
      run: |
        echo '${{ secrets.ANDROID_KEYSTORE_BASE64 }}' | base64 -d > android/key.jks
        echo 'storeFile=key.jks' >> android/key.properties
        echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' >> android/key.properties
        echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' >> android/key.properties
        echo 'keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}' >> android/key.properties
    
    - name: Google Play API í‚¤ ì„¤ì •
      run: |
        echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android/fastlane/google-play-api-key.json
    
    - name: Android ë² íƒ€ ë°°í¬ (Internal Testing)
      if: github.event.inputs.release_type == 'beta' || (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'beta'))
      working-directory: android
      run: |
        fastlane beta
    
    - name: Android í”„ë¡œë•ì…˜ ë°°í¬ (Google Play)
      if: github.event.inputs.release_type == 'release' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'beta'))
      working-directory: android
      run: |
        fastlane deploy

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [deploy_ios, deploy_android]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ðŸš€ íƒ€ì´ë¨¸ì•± ìžë™ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **í”Œëž«í¼**: ${{ github.event.inputs.platform || 'both' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°°í¬ íƒ€ìž…**: ${{ github.event.inputs.release_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹¤í–‰ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ë°°í¬ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
        echo "- iOS: ${{ needs.deploy_ios.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Android: ${{ needs.deploy_android.result }}" >> $GITHUB_STEP_SUMMARY
